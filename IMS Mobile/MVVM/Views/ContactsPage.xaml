<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="IMS_Mobile.MVVM.Views.ContactsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:Controls="clr-namespace:IMS_Mobile.Controls"
    xmlns:Converters="clr-namespace:IMS_Mobile.Converters"
    xmlns:Models="clr-namespace:IMS_Mobile.MVVM.Models"
    xmlns:ViewModels="clr-namespace:IMS_Mobile.MVVM.ViewModels"
    xmlns:editors="clr-namespace:Syncfusion.Maui.Inputs;assembly=Syncfusion.Maui.Inputs"
    x:DataType="ViewModels:ContactsVM"
    BackgroundColor="White"
    Shell.NavBarIsVisible="False">

    <ContentPage.Resources>
        <Converters:ContactInfoConverter x:Key="ContactInfoConverter" />
        <Converters:CreditScoreColorConverter x:Key="CreditScoreColorConverter" />
        <Converters:InitialsConverter x:Key="InitialsConverter" />
        <!--  Data Template for Contact Items  -->
        <DataTemplate x:Key="ContactItemTemplate" x:DataType="Models:Contact">
            <Border StyleClass="TransactionCardStyle">
                <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto">
                    <!--  Contact Avatar  -->
                    <Border
                        Grid.RowSpan="2"
                        Grid.Column="0"
                        Margin="0,0,12,0"
                        Background="#F5F5F5"
                        HeightRequest="60"
                        StrokeShape="RoundRectangle 30"
                        WidthRequest="60">
                        <Label
                            FontFamily="poppinbold"
                            FontSize="20"
                            HorizontalOptions="Center"
                            Text="{Binding Name, Converter={StaticResource InitialsConverter}}"
                            TextColor="#666666"
                            VerticalOptions="Center" />
                    </Border>

                    <!--  Contact Details  -->
                    <VerticalStackLayout
                        Grid.Row="0"
                        Grid.Column="1"
                        Spacing="4">
                        <Label
                            FontFamily="poppinbold"
                            FontSize="16"
                            Text="{Binding Name}"
                            TextColor="Black" />
                        <Label
                            FontFamily="poppinregular"
                            FontSize="14"
                            Text="{Binding Converter={StaticResource ContactInfoConverter}}"
                            TextColor="#666666" />
                    </VerticalStackLayout>

                    <!--  Credit Score Indicator  -->
                    <Border
                        Grid.Row="1"
                        Grid.Column="1"
                        Padding="8,4"
                        Background="{Binding CreditScore, Converter={StaticResource CreditScoreColorConverter}}"
                        HorizontalOptions="Start"
                        StrokeShape="RoundRectangle 4"
                        VerticalOptions="End">
                        <Label
                            FontFamily="poppinregular"
                            FontSize="12"
                            HorizontalOptions="Center"
                            Text="{Binding CreditScore, StringFormat='Credit: {0} LBP'}"
                            TextColor="White" />
                    </Border>

                    <!--  Edit Icon  -->
                    <VerticalStackLayout
                        Grid.RowSpan="2"
                        Grid.Column="2"
                        Spacing="25"
                        VerticalOptions="Center">
                        <Border
                            Background="Transparent"
                            HeightRequest="24"
                            HorizontalOptions="End"
                            StrokeShape="RoundRectangle 5"
                            VerticalOptions="Center"
                            WidthRequest="24">
                            <Label
                                FontSize="16"
                                HorizontalOptions="Center"
                                Text="âœï¸"
                                VerticalOptions="Center" />
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ViewModels:ContactsVM}}, Path=EditContactCommand}" CommandParameter="{Binding .}" />
                            </Border.GestureRecognizers>
                        </Border>
                        <Border
                            Background="Transparent"
                            HeightRequest="24"
                            HorizontalOptions="End"
                            StrokeShape="RoundRectangle 5"
                            VerticalOptions="Center"
                            WidthRequest="24">
                            <Label
                                FontSize="16"
                                HorizontalOptions="Center"
                                Text="ðŸ—‘ï¸"
                                VerticalOptions="Center" />
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ViewModels:ContactsVM}}, Path=DeleteContactCommand}" CommandParameter="{Binding .}" />
                            </Border.GestureRecognizers>
                        </Border>
                    </VerticalStackLayout>

                </Grid>
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ViewModels:ContactsVM}}, Path=ShowDetailsCommand}" CommandParameter="{Binding .}" />
                </Border.GestureRecognizers>
            </Border>
        </DataTemplate>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,*">
        <!--  Header  -->
        <Grid
            Grid.Row="0"
            Margin="20,0,20,10"
            ColumnDefinitions="*,Auto">
            <Label
                Grid.Column="0"
                HorizontalOptions="Center"
                StyleClass="TitleStyle"
                Text="Contacts" />
            <Border
                Grid.Column="1"
                Background="#F5F5F5"
                HeightRequest="40"
                HorizontalOptions="End"
                StrokeShape="RoundRectangle 8"
                VerticalOptions="End"
                WidthRequest="40">
                <Label
                    FontSize="20"
                    HorizontalOptions="Center"
                    Text="+"
                    VerticalOptions="Center" />
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding AddContactCommand}" />
                </Border.GestureRecognizers>
            </Border>
        </Grid>

        <!--  Search Bar  -->
        <Border
            Grid.Row="1"
            Margin="20,10,20,20"
            Padding="16,12"
            Background="#F0F8F0"
            StrokeShape="RoundRectangle 12">
            <Grid ColumnDefinitions="Auto,*">
                <Label
                    Grid.Column="0"
                    Margin="0,0,8,0"
                    FontSize="16"
                    Text="ðŸ”"
                    VerticalOptions="Center" />
                <editors:SfAutocomplete
                    x:Name="autocomplete"
                    Grid.Column="1"
                    Margin="0,5,0,0"
                    BackgroundColor="#F0F8F0"
                    DisplayMemberPath="Name"
                    EnableAutoSize="True"
                    HighlightedTextColor="#4CAF50"
                    HighlightedTextFontAttributes="Bold"
                    HorizontalOptions="Fill"
                    ItemsSource="{Binding Contacts}"
                    MaxDropDownHeight="250"
                    Placeholder="Search Contacts ..."
                    SelectedItems="{Binding SelectedContacts, Mode=TwoWay}"
                    SelectionChanged="autocomplete_SelectionChanged"
                    SelectionMode="Multiple"
                    SelectionTextHighlightColor="#4CAF50"
                    Stroke="Transparent"
                    StyleClass="TitleText"
                    TextHighlightMode="FirstOccurrence"
                    TextMemberPath="Name"
                    TokensWrapMode="Wrap"
                    VerticalOptions="Center" />
            </Grid>
        </Border>

        <!--  Contacts List  -->
        <RefreshView
            Grid.Row="2"
            Command="{Binding RefreshCommand}"
            IsRefreshing="{Binding IsRefreshing}"
            RefreshColor="LightGreen">
            <CollectionView
                Margin="0,0,0,10"
                ItemTemplate="{StaticResource ContactItemTemplate}"
                ItemsSource="{Binding FilteredContacts}"
                VerticalScrollBarVisibility="Always">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical" Span="1" />
                </CollectionView.ItemsLayout>
            </CollectionView>
        </RefreshView>

    </Grid>
</ContentPage>