<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="IMS_Mobile.MVVM.Views.SellProducts"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:Models="clr-namespace:IMS_Mobile.MVVM.Models"
    xmlns:ViewModels="clr-namespace:IMS_Mobile.MVVM.ViewModels"
    xmlns:bottomSheet="clr-namespace:Syncfusion.Maui.Toolkit.BottomSheet;assembly=Syncfusion.Maui.Toolkit"
    xmlns:editors="clr-namespace:Syncfusion.Maui.Inputs;assembly=Syncfusion.Maui.Inputs"
    x:DataType="ViewModels:InventoryVM"
    BackgroundColor="White"
    Shell.NavBarIsVisible="False">

    <Grid RowDefinitions="Auto,Auto,*,Auto">

        <!--  Header (Row 0) - Match Inventory Page Style  -->
        <Grid
            Grid.Row="0"
            Margin="20,0,20,10"
            ColumnDefinitions="*,Auto">
            <Label
                Grid.Column="0"
                HorizontalOptions="Center"
                StyleClass="TitleStyle"
                Text="Sell Product" />
            <Border
                Grid.Column="1"
                Background="#F5F5F5"
                HeightRequest="40"
                HorizontalOptions="End"
                StrokeShape="RoundRectangle 8"
                VerticalOptions="End"
                WidthRequest="40">
                <Label
                    FontSize="20"
                    HorizontalOptions="Center"
                    Text="ðŸ›’"
                    VerticalOptions="Center" />
            </Border>
        </Grid>

        <!--  Search Bar (Row 1) - Match Inventory Page Style  -->
        <Border
            Grid.Row="1"
            Margin="20,10,20,20"
            Padding="16,12"
            Background="#F0F8F0"
            HeightRequest="70"
            StrokeShape="RoundRectangle 15">
            <Grid ColumnDefinitions="Auto,*">
                <Label
                    Grid.Column="0"
                    Margin="0,0,8,0"
                    FontSize="16"
                    Text="ðŸ”"
                    VerticalOptions="Center" />
                <editors:SfAutocomplete
                    x:Name="autocomplete"
                    Grid.Column="1"
                    Margin="0,5,0,0"
                    BackgroundColor="#F0F8F0"
                    DisplayMemberPath="Name"
                    EnableAutoSize="True"
                    HighlightedTextColor="#4CAF50"
                    HighlightedTextFontAttributes="Bold"
                    HorizontalOptions="Fill"
                    ItemsSource="{Binding Products}"
                    MaxDropDownHeight="250"
                    Placeholder="Search Product ..."
                    SelectedItems="{Binding SelectedProducts, Mode=TwoWay}"
                    SelectionChanged="autocomplete_SelectionChanged"
                    SelectionMode="Multiple"
                    SelectionTextHighlightColor="#4CAF50"
                    Stroke="Transparent"
                    StyleClass="TitleText"
                    TextHighlightMode="FirstOccurrence"
                    TextMemberPath="Name"
                    TokensWrapMode="Wrap"
                    VerticalOptions="Center" />
            </Grid>
        </Border>

        <!--  Product Collection (Row 2)  -->
        <RefreshView
            Grid.Row="2"
            Command="{Binding RefresCartItems}"
            IsRefreshing="{Binding IsRefreshing}"
            RefreshColor="LightGreen">
            <CollectionView ItemsSource="{Binding FilteredProducts}" SelectionMode="None">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical" Span="1" />
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="Models:Product">
                        <Border StyleClass="ProductItemStyle">
                            <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="8">
                                <!--  Product Image  -->
                                <Border
                                    Grid.Column="0"
                                    Background="#F5F5F5"
                                    HeightRequest="60"
                                    StrokeShape="RoundRectangle 10"
                                    WidthRequest="60">
                                    <Image Aspect="AspectFit" Source="product.png" />
                                </Border>

                                <!--  Product Info  -->
                                <StackLayout
                                    Grid.Column="1"
                                    Grid.ColumnSpan="2"
                                    Margin="10,0,0,0"
                                    Spacing="2"
                                    VerticalOptions="Center">
                                    <Label
                                        LineBreakMode="WordWrap"
                                        MaxLines="2"
                                        StyleClass="RegularTextStyle"
                                        Text="{Binding Name}" />
                                    <Label
                                        LineBreakMode="WordWrap"
                                        StyleClass="PriceStyle"
                                        Text="{Binding Price, StringFormat='${0:F2}'}" />
                                    <Label
                                        LineBreakMode="WordWrap"
                                        StyleClass="StockStyle"
                                        Text="{Binding stock, StringFormat='Stock: {0}'}" />
                                </StackLayout>

                                <!--  Selection Checkbox  -->
                                <CheckBox
                                    Grid.Column="3"
                                    CheckedChanged="CheckBox_CheckedChanged"
                                    IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                    VerticalOptions="Center"
                                    Color="#4CAF50" />
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>


        <!--  Cart Summary (Row 3) - Footer  -->
        <Border
            Grid.Row="3"
            Padding="20,15"
            Background="#F8F9FA"
            Stroke="#E0E0E0"
            StrokeShape="RoundRectangle 15,15,0,0"
            StrokeThickness="1">
            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="15">
                <StackLayout Grid.Column="0" VerticalOptions="Center">
                    <Label StyleClass="RegularTextStyle" Text="{Binding CartItemsCount, StringFormat='Cart: {0} items'}" />
                    <Label StyleClass="PriceStyle" Text="{Binding CartValue, StringFormat='Total: {0} LBP'}" />
                </StackLayout>
                <ImageButton
                    Grid.Column="1"
                    Padding="20,10"
                    Clicked="Button_Clicked"
                    CornerRadius="15"
                    Source="cart.png"
                    StyleClass="CashButtonStyle" />

            </Grid>
        </Border>
        <bottomSheet:SfBottomSheet
            x:Name="bottomSheet"
            Grid.Row="0"
            Grid.RowSpan="4"
            Background="White"
            CollapseOnOverlayTap="False"
            CornerRadius="20,20,0,0"
            EnableSwiping="True"
            GrabberBackground="LightGreen"
            State="FullExpanded">
            <bottomSheet:SfBottomSheet.BottomSheetContent>
                <VerticalStackLayout>
                    <!--  Header with Title and Close Button  -->
                    <Grid Padding="20,10" ColumnDefinitions="*,Auto">
                        <Label
                            Grid.Column="0"
                            HorizontalOptions="Start"
                            StyleClass="TitleStyle"
                            Text="Shopping Cart" />
                        <Button
                            Grid.Column="1"
                            Background="LightGreen"
                            Clicked="CloseBottomSheet"
                            CornerRadius="100"
                            HeightRequest="50"
                            Text="âŒ"
                            WidthRequest="50" />
                    </Grid>

                    <CollectionView
                        HeightRequest="500"
                        HorizontalOptions="Fill"
                        ItemsSource="{Binding FinalCartItems}"
                        SelectionMode="None">
                        <CollectionView.EmptyView>
                            <StackLayout
                                Padding="20"
                                HorizontalOptions="Center"
                                VerticalOptions="Center">
                                <Image
                                    Aspect="AspectFit"
                                    HeightRequest="80"
                                    IsAnimationPlaying="True"
                                    Source="emptycart.png" />
                                <Label
                                    HorizontalOptions="Center"
                                    StyleClass="TitleStyle"
                                    Text="Cart Is Empty" />
                                <Label
                                    HorizontalOptions="Center"
                                    StyleClass="SmallTextStyle"
                                    Text="Add items to your cart to get started" />
                            </StackLayout>
                        </CollectionView.EmptyView>
                        <CollectionView.ItemsLayout>
                            <GridItemsLayout Orientation="Vertical" Span="1" />
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="Models:Product">
                                <Border Margin="10,5" StyleClass="ProductItemStyle">
                                    <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="8">
                                        <!--  Product Image  -->
                                        <Border
                                            Grid.Column="0"
                                            Background="#F5F5F5"
                                            HeightRequest="60"
                                            StrokeShape="RoundRectangle 10"
                                            WidthRequest="60">
                                            <Image Aspect="AspectFit" Source="product.png" />
                                        </Border>

                                        <!--  Product Info  -->
                                        <StackLayout
                                            Grid.Column="1"
                                            Margin="10,0,0,0"
                                            Spacing="2"
                                            VerticalOptions="Center">
                                            <Label
                                                LineBreakMode="WordWrap"
                                                MaxLines="2"
                                                StyleClass="RegularTextStyle"
                                                Text="{Binding Name}" />
                                            <Label
                                                LineBreakMode="WordWrap"
                                                StyleClass="PriceStyle"
                                                Text="{Binding Price, StringFormat='${0:F2}'}" />
                                            <Label
                                                LineBreakMode="WordWrap"
                                                StyleClass="StockStyle"
                                                Text="{Binding stock, StringFormat='Stock: {0}'}" />
                                        </StackLayout>

                                        <!--  Quantity Control  -->
                                        <StackLayout
                                            Grid.Column="2"
                                            HorizontalOptions="End"
                                            Orientation="Horizontal"
                                            Spacing="4"
                                            VerticalOptions="Center">

                                            <!--  Decrease Button  -->
                                            <Border
                                                Background="#4CAF50"
                                                HeightRequest="30"
                                                StrokeShape="RoundRectangle 15"
                                                WidthRequest="30">
                                                <Label
                                                    FontSize="16"
                                                    HorizontalOptions="Center"
                                                    Text="-"
                                                    TextColor="White"
                                                    VerticalOptions="Center" />
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ViewModels:InventoryVM}}, Path=DecreaseQuantityCommand}" CommandParameter="{Binding .}" />
                                                </Border.GestureRecognizers>
                                            </Border>

                                            <!--  Quantity Entry  -->
                                            <Entry
                                                FontSize="12"
                                                HeightRequest="30"
                                                HorizontalTextAlignment="Center"
                                                Keyboard="Numeric"
                                                StyleClass="QuantityEntryStyle"
                                                Text="{Binding Quantity}"
                                                TextChanged="Entry_TextChanged"
                                                WidthRequest="40" />

                                            <!--  Increase Button  -->
                                            <Border
                                                Background="#4CAF50"
                                                HeightRequest="30"
                                                StrokeShape="RoundRectangle 15"
                                                WidthRequest="30">
                                                <Label
                                                    FontSize="16"
                                                    HorizontalOptions="Center"
                                                    Text="+"
                                                    TextColor="White"
                                                    VerticalOptions="Center" />
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ViewModels:InventoryVM}}, Path=IncreaseQuantityCommand}" CommandParameter="{Binding .}" />
                                                </Border.GestureRecognizers>
                                            </Border>
                                        </StackLayout>

                                        <!--  Delete Icon  -->
                                        <Border
                                            Grid.Column="3"
                                            Background="#FFEBEE"
                                            HeightRequest="30"
                                            HorizontalOptions="End"
                                            StrokeShape="RoundRectangle 15"
                                            VerticalOptions="Start"
                                            WidthRequest="30">
                                            <Label
                                                FontSize="16"
                                                HorizontalOptions="Center"
                                                Text="ðŸ—‘ï¸"
                                                VerticalOptions="Center" />
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ViewModels:InventoryVM}}, Path=RemoveFromCartCommand}" CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>
                                        </Border>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!--  Cart Summary  -->
                    <Border
                        Margin="10"
                        Padding="15"
                        StrokeShape="RoundRectangle 15"
                        StyleClass="CartSummaryStyle">
                        <Grid ColumnDefinitions="*,Auto">
                            <StackLayout Grid.Column="0">
                                <Label StyleClass="RegularTextStyle" Text="{Binding CartItemsCount, StringFormat='Items: {0}'}" />
                                <Label StyleClass="TotalAmountStyle" Text="{Binding CartValue, StringFormat='Total: {0:F2} LBP'}" />
                            </StackLayout>
                            <HorizontalStackLayout
                                Grid.Column="1"
                                HorizontalOptions="Center"
                                Spacing="25"
                                VerticalOptions="Center">
                                <Button
                                    CornerRadius="10"
                                    StyleClass="CashButtonStyle"
                                    Text="On-Tab" />
                                <Button
                                    Clicked="SellCash"
                                    CornerRadius="10"
                                    StyleClass="CashButtonStyle"
                                    Text="Cash" />
                            </HorizontalStackLayout>

                        </Grid>
                    </Border>
                </VerticalStackLayout>
            </bottomSheet:SfBottomSheet.BottomSheetContent>
        </bottomSheet:SfBottomSheet>
    </Grid>
</ContentPage>